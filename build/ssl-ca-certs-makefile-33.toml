

[tasks.generate-ca-ssl-certs-prepare]
private = true
workspace = false
env = { "TEST_CERTS_DIR" = "${ROOT_PROJECT_DIR}/target/generated-test-resources/ssl33" }
script = ''' mkdir -p "${TEST_CERTS_DIR}" '''



[tasks.delete-ca-ssl-certs]
private = true
workspace = false
cwd = "${TEST_CERTS_DIR}"
script = [ "rm -f *.key *.crt *.cert *.pem *.csr" ]
dependencies = ["generate-ca-ssl-certs-prepare"]



[tasks.gen-ca-ssl-certs]
#private = true
workspace = false
cwd = "${TEST_CERTS_DIR}"
script = '''
    openssl req -x509 -new -nodes -newkey rsa:2048 -keyout myCA.key \
        -sha256 -days 1825 -out myCA.crt -subj /CN='localhost ca'

    openssl req -newkey rsa:2048 -nodes -keyout localhost.key -out localhost.csr \
        -subj /CN=localhost -addext subjectAltName=DNS:localhost

    openssl x509 -req -in localhost.csr -copy_extensions copy \
        -CA myCA.crt -CAkey myCA.key -CAcreateserial -out localhost.crt -days 365 -sha256

    # sudo cp myCA.crt /etc/pki/ca-trust/source/anchors/
    # sudo update-ca-trust
'''
dependencies = ["generate-ca-ssl-certs-prepare"]
